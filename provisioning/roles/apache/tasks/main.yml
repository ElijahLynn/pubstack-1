---
- name: Include OS-specific variables.
  include_vars: "{{ ansible_os_family }}.yml"

- name: Ensure Apache is installed (RedHat).
  yum: >
    name={{ item }}
    state=installed
    enablerepo={{ apache_enablerepo }}
  with_items: apache_packages

- name: Configure Apache (RedHat).
  lineinfile: >
    dest=/etc/httpd/conf/httpd.conf
    regexp="{{ item.regexp }}"
    line="{{ item.line }}"
    state=present
  with_items:
  - {
    regexp: "^Listen ",
    line: "Listen {{ apache_listen_port }}"
  }
  - {
    regexp: "^NameVirtualHost ",
    line: "NameVirtualHost *:{{ apache_listen_port }}"
  }
  notify: restart apache

- name: Add apache vhosts configuration.
  template: >
    src=vhosts.conf.j2
    dest={{ apache_conf_path }}/vhosts.conf
    owner=root group=root mode=644
  notify: restart apache
  when: sites is defined

- name: "create pubstack directory"
  file: path=/var/www/pubstack state=directory

- name: "copy index.php"
  template: src=index.php.j2 dest=/var/www/pubstack/index.php

- name: "copy Apache2 conf"
  copy: src={{ item }} dest={{ apache_conf_path }}
  with_fileglob:
    - "conf-available/*"

- name: "start apache"
  service: >
    name={{ apache_daemon }}
    state=started
    enabled=yes

- name: Add hosts entry for each site.
  lineinfile:
    dest=/etc/hosts
    line="127.0.0.1  {{ item.vhost.servername }}"
    insertafter=EOF
  with_items: sites
